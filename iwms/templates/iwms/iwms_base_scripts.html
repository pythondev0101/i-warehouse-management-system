{% extends "admin/admin_base.html" %}

{% block style %}
<style>
    .myHiddenColumn {
        display: none;
    }
</style>
{% endblock %}


{% block inner_footer %}
{% if context['model'] == 'purchase_order' %}
<div class="app-footer-right">
    <button type="button" class="btn btn-secondary" onclick="history.back(-1)" 
    style="margin-right: 10px;">Cancel</button>
    <input form="edit_form" type="submit" style="margin-right: 10px;" name='btn_submit' class="btn btn-primary" value="Save and Print">
    <input form="edit_form" type="submit" class="btn btn-primary" name='btn_submit' value="Save">
</div>
{% else %}
<div class="app-footer-right">
    <button type="button" class="btn btn-secondary" onclick="history.back(-1)" 
    style="margin-right: 10px;">Cancel</button>
    <button form="edit_form" type="submit" class="btn btn-primary">Save</button>
</div>
{% endif %}
{% endblock %}



<!-- CHECK KUNG PO O SI ANG MAIINCLUDE NA SCRIPT -->
{% block scripts %}
{% if context['model'] == 'purchase_order' %}
{% elif context['model'] == 'stock_receipt' %}

<!-- !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!PUTAWAY!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! -->
<!-- !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!PUTAWAY!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! -->
{% elif context['model'] == 'putaway' %}
<script>

</script>
<!-- !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! SALES ORDER !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! -->
{% elif context['model'] == 'sales_order' %}
<script>
    $(document).ready(function(){
        var table_sr = $('#tbl_client_modal').DataTable({
            "pageLength": 8
        });

        var table_product_line = $('#tbl_product_modal').DataTable({
            "order": [[2,'asc']]
        });

        $("#tbl_client_modal").on('click','tr',function(){
            $(this).addClass('selected').siblings().removeClass('selected');    
         });

        $('#btn_select_client').click(function(){
            var client = $("#tbl_client_modal tr.selected td:nth-child(3)").html();
            var term = $("#tbl_client_modal tr.selected td:nth-child(4)").html();
            var ship_via = $("#tbl_client_modal tr.selected td:nth-child(5)").html();
            $("#client_name").val(client);
            $("#term").val(term);
            $("#ship_via").val(ship_via);
        });

        $("#btn_add_product").click(function(){
            var csrf_token = "{{ csrf_token() }}";
            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrf_token);
                    }
                }
            });
            $("tr").each(function() {
                var check = $(this).find("input.chkbox").is(':checked');
                if(check){
                    var item_no = $(this).find("td").eq(2).html();
                    var item_name = $(this).find("td").eq(3).html();
                    var item_description = $(this).find("td").eq(4).html();
                    var item_id = $(this).find("td").eq(0).html();
                    var item_available_qty = $(this).find("td").eq(6).html();
                    var item_expiry_date = $(this).find("td").eq(5).html();
                    var item_price = $(this).find("td").eq(7).html();
                    var item_uom = `<select name="uom_${item_id}" style='width':100%;'>`;
                        $.ajax({
                            url: "/iwms/_get_uom_line",
                            type: 'POST',
                            async: false,
                            dataType: 'json',
                            data: JSON.stringify({'stock_item_id':0}),
                            contentType: "application/json; charset=utf-8",
                            success: function(data){
                                for (i=0; i < data.uom_lines.length; ++i){
                                    item_uom += `<option value='${data.uom_lines[i].id}'>${data.uom_lines[i].code}</option>`;
                                }
                            }
                        });
                    var _trim_item_available_qty = $.trim(item_available_qty);
                    $('#tbl_so_line tr:last').after(
                        `<tr>
                            <td style="display:none;"><input name="products[]" type="hidden" value="${item_id}"></td>
                            <td style="display:none;">${item_description}</td>
                            <td style="display:none;">${item_expiry_date}</td>
                            <td><input class="chkbox" type="checkbox"></td>
                            <td class='text-center'>${item_no}</td>
                            <td class='text-center'>${item_name}</td>
                            <td class='text-center'>${item_uom}</td>
                            <td class='text-center'><input class="input_qty" max="${_trim_item_available_qty}" name="qty_${item_id}" type="number" style="width:100px" value="0"></td>
                            <td class='text-center'>${item_available_qty}</td>
                            <td class='text-center'><input class="input_price" name="price_${item_id}" type="number" value="${item_price}" style="width:100px"></td>
                            <td class='text-center'><input class="input_subtotal" name="subtotal_${item_id}" type="number" value="0.00" style="width:100px" readonly></td>
                        </tr>
                        `
                        );
                    table_product_line.row($(this)).remove().draw();
                }
            });
        });

        $("#btn_delete_line").click(function(){
            $("#tbl_so_line tr").each(function() {
                var check = $(this).find("input.chkbox").is(':checked');
                if (check){
                    var row = table_product_line.row.add([
                        $(this).find("input").eq(0).val(),
                        "<input class='chkbox' type='checkbox'>",
                        $(this).find("td").eq(4).html(),
                        $(this).find("td").eq(5).html(),
                        $(this).find("td").eq(1).html(),
                        $(this).find("td").eq(2).html(),
                        $(this).find("td").eq(8).html(),
                        $(this).find("input").eq(3).val(),
                    ]);
                    table_product_line.row(row).column(0).nodes().to$().addClass('myHiddenColumn');
                    table_product_line.row(row).column(7).nodes().to$().addClass('myHiddenColumn');
                    table_product_line.row(row).draw();
                    $(this).remove();
                }
            });
        });
        $('#tbl_so_line').on('change', 'input', function(){
            var row = $(this).closest("tr");
            var price = row.find('.input_price').val();
            var qty = row.find('.input_qty').val();
            var amount = parseFloat(qty) * parseFloat(price); 
            row.find('.input_subtotal').val(amount.toFixed(2));
            var total = 0;
            $("#tbl_so_line tr").each(function() {
                if ($(this).find("input").eq(0).val()){
                    var subtotal = $(this).find("input").eq(4).val();
                    total += parseFloat(subtotal);
                    $("#p_total").html(`<strong>TOTAL: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</strong>${total}`);
                }
            });
        });
    });
    var _total = 0
    $("#tbl_so_line tr").each(function() {
        var row = $(this).closest("tr");
        var price = row.find('.input_price').val();
        var qty = row.find('.input_qty').val();
        var amount = parseFloat(qty) * parseFloat(price); 
        row.find('.input_subtotal').val(amount.toFixed(2));
        var _total = 0;
        $("#tbl_so_line tr").each(function() {
            if ($(this).find("input").eq(0).val()){
                var subtotal = $(this).find("input").eq(4).val();
                _total += parseFloat(subtotal);
                $("#p_total").html(`<strong>TOTAL: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</strong>${_total}`);
            }
        });
    });
    (function() {
        var fixed_footer = document.getElementById('chkbox_fixed_footer');
        setTimeout(function() {
          fixed_footer.click();
        }, 100);
      })();
</script>

<!-- !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! PICKING !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! -->
{% elif context['model'] == 'picking' %}
<script>
    $(document).ready(function(){
        var table_sr = $('#tbl_so_modal').DataTable({
            "pageLength": 8
        });

        var table_so_line = $('#tbl_so_line_modal').DataTable({
            "order": [[1,'asc']]
        });

        $("#tbl_so_modal").on('click','tr',function(){
            $(this).addClass('selected').siblings().removeClass('selected');    
        });


        $("#tbl_so_line_modal").on('click','tr',function(){
            $(this).addClass('selected').siblings().removeClass('selected');
            $("#item_name").val($("#tbl_so_line_modal tr.selected td:nth-child(3)").html());
            $("#unit").val($("#tbl_so_line_modal tr.selected td:nth-child(5)").html());
            $("#lot_no").val($("#tbl_so_line_modal tr.selected td:nth-child(6)").html());
            $("#expiry").val($("#tbl_so_line_modal tr.selected td:nth-child(7)").html());
            $("#bin_location").val($("#tbl_so_line_modal tr.selected td:nth-child(4)").html());
            if (!($("#item_name").val() == '')){
                $('#btn_add_so_line').prop('disabled', false);
            }  
            
            var _unit_qty = $("#tbl_so_line_modal tr.selected td:nth-child(8)").html();
            $("#quantity").attr('max',_unit_qty);
        });


        $("#btn_add_so_line").click(function(){
            $("#p_item_name").html("<strong>ITEM NAME: </strong>" + $("#item_name").val());
            $("#p_qty").html("<strong>PICK QUANTITY: </strong>" + $("#quantity").val());
            $("#p_bin_location").html("<strong>LOCATION: </strong>" + $("#bin_location").val());
            $("#p_lot_no").html("<strong>LOT NUMBER: </strong>" + $("#lot_no").val());
            $("#p_expiry_date").html("<strong>EXPIRY DATE: </strong>" + $("#expiry").val());
        });


        $('#btn_select_so').click(function(){
            // Clearing SR line and PO line table

            table_so_line.clear().draw();
            $("#tbl_so_line tr").each(function() {
                if ($(this).find("input").eq(0).val()){
                    $(this).remove();
                }
            });

            var so = $("#tbl_so_modal tr.selected td:nth-child(2)").html();
            var so_id = $("#tbl_so_modal tr.selected td:nth-child(1)").html();
            var remarks = $("#tbl_so_modal tr.selected td:nth-child(4)").html();
            $("#so_number").val(so);
            $("#remarks").val(remarks);

            var csrf_token = "{{ csrf_token() }}";
            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrf_token);
                    }
                }
            });

            $.ajax({
                url: '/iwms/_get_so_line',
                type: 'POST',
                dataType: 'json',
                data: JSON.stringify({'so_id':so_id}),
                contentType: "application/json; charset=utf-8",
                success: function(data){
                    for (i=0; i < data.items.length; ++i){
                        var row = table_so_line.row.add([
                        data.items[i].id,
                        data.items[i].number,
                        data.items[i].name,
                        data.items[i].bin_location,
                        data.items[i].uom,
                        data.items[i].lot_no,
                        data.items[i].expiry_date,
                        data.items[i].qty,data.items[i].issued_qty,
                        ]);
                        table_so_line.row(row).column(0).nodes().to$().addClass('myHiddenColumn');
                        if (data.items[i].qty == 0){
                            table_so_line.row(row).nodes().to$().addClass('list-group-item-success');
                        }else if(data.items[i].issued_qty == 0){
                            table_so_line.row(row).nodes().to$().addClass('list-group-item-danger');
                        }else{
                            table_so_line.row(row).nodes().to$().addClass('list-group-item-warning');
                        }
                        table_so_line.row(row).draw();
                    }
                }
            });
        });
        

        $("#btn_confirm_so_line").click(function(){
            var stock_id = $("#tbl_so_line_modal tr.selected td:first").html();
            var item_no = $("#tbl_so_line_modal tr.selected td:nth-child(2)").html();
            var item_name = $("#tbl_so_line_modal tr.selected td:nth-child(3)").html();
            var base_uom = $("#tbl_so_line_modal tr.selected td:nth-child(6)").html();
            var lot_no = $("#lot_no").val();
            var expiry_date = $("#expiry").val();
            var bin_location = $("#bin_location").val();
            var quantity = $("#quantity").val();
            var timestamp = + new Date();
            var picker = "{{current_user.username}}";

                var row = $("#tbl_so_line_modal tr.selected");
                $('#tbl_pwy_item_line tr:last').after(
                    `<tr>
                        <td style="display:none;"><input name="pick_items[]" type="hidden" value="${stock_id}"></input></td>
                        <td></td>
                        <td class='text-center'>${item_no}</td>
                        <td class='text-center'>${item_name}</td>
                        <td class='text-center'><input name="bin_location_${stock_id}" type="text" value="${bin_location}" style="width:50px" readonly></td>
                        <td class='text-center'><input name="lot_no_${stock_id}" type="text" value="${lot_no}" style="width:50px" readonly></td>
                        <td class='text-center'><input name="expiry_${stock_id}" type="text" value="${expiry_date}" style="width:80px" readonly></td>
                        <td class='text-center'><input name="uom_${stock_id}" type="text" value="${base_uom}" style="width:50px" readonly></td>
                        <td class='text-center'><input name="qty_${stock_id}" type="text" value="${quantity}" style="width:50px" readonly></td>
                        <td class='text-center'><input name="timestamp_${stock_id}" type="text" value="${timestamp}" style="width:110px" readonly></td>
                        <td class='text-center'>${picker}</td>
                    </tr>
                    `
                    );

                // ADDING NEW QUANTITY TO THE QTY PICKED 
                var qty_picked = $("#tbl_so_line_modal tr.selected td:nth-child(9)");
                var _picked_item = parseInt(qty_picked.html()) + parseInt($("#quantity").val());
                qty_picked.html(_picked_item);
                
                // MAKING ROW COLOR AND REDUCING QTY
                var qty = $("#tbl_so_line_modal tr.selected td:nth-child(8)");
                var _qty_item = parseInt(qty.html()) - parseInt($("#quantity").val());
                qty.html(_qty_item);
                var issued_qty = $("#tbl_so_line_modal tr.selected td:nth-child(9)");

                if (parseInt(qty.html()) == 0){
                    row.removeClass('list-group-item-danger')
                    row.removeClass('list-group-item-warning')
                    row.addClass('list-group-item-success');
                }else{
                    row.removeClass('list-group-item-danger')
                    row.addClass('list-group-item-warning');
                }

                // CLEANING INPUTS
                $('#btn_add_sr_line').prop('disabled', true);
                $("#p_item_name").html("");
                $("#p_qty").html("");
                $("#p_lot_no").html("");
                $("#p_expiry_date").html("");
                $("#item_name").val("");
                $("#bin_location").val("");
                $("#unit").val("");
                $("#quantity").val("0");
                $("#expiry").val("");
                $("#lot_no").val("");
        });

       
    });

    (function() {
        var fixed_footer = document.getElementById('chkbox_fixed_footer');
        setTimeout(function() {
          fixed_footer.click();
        }, 100);
      })();
</script>
<!-- END NG CHECKING -->
{% endif %}
{% endblock %}


{% block modals %}
    {% if context['model'] == 'purchase_order' %}

    {% elif context['model'] == 'stock_receipt' %}
    

    {% elif context['model'] == 'putaway' %}


    {% elif context['model'] == 'sales_order' %}
        {% include "iwms/sales_order/search_client_modal.html" %}
        {% include "iwms/sales_order/add_product_modal.html" %}
    
    {% elif context['model'] == 'picking' %}
        {% include "iwms/picking/search_so_modal.html" %}
        {% include "iwms/picking/so_line_modal.html" %}
        {% include "iwms/picking/confirm_modal.html" %}
    {% endif %}
{% endblock %}


{% block toast %}
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<div id="toast-container" class="toast-top-center">
    {% for category, message in messages %}
        {% if category == 'success' %}
        <div class="toast toast-success" aria-live="polite">
            <div class="toast-progress" style="width: 0%;"></div>
            <button type="button" class="toast-close-button" role="button" onclick="close_toast()">×</button>
            <div class="toast-title">Success!</div>
            <div class="toast-message">{{ message }}</div>
        </div>
        {% elif category == 'error' %}
        <div class="toast toast-error" aria-live="polite">
            <div class="toast-progress" style="width: 0%;"></div>
            <button type="button" class="toast-close-button" role="button" onclick="close_toast()">×</button>
            <div class="toast-title">Error!</div>
            <div class="toast-message">{{ message }}</div>
        </div>
        {% endif %}
    {% endfor %}
</div>
{% endif %}
{% endwith %}
{% endblock %}